---
title: "Distinction Centrality Analysis"
execute: 
  eval: true
  echo: false
  output: true
  warning: false
  message: false
---

```{r Loading Functions}
   library(igraph)
   library(ggraph)
   library(here)
   library(networkdata)
   library(ggpubr)
   source(here("Functions", "distinction.R"))
   source(here("Functions", "distinction.new.R"))
   source(here("Functions", "make.broker.trees.R"))
   source(here("Functions", "plot.graph.norm.R"))
   source(here("Functions", "tab.cent.R"))
```

## Toy Networks

```{r Toy Examples}
   g1 <- make_star(7, mode = "undirected") # star graph
   g2 <- g1 + edge(2,3)
   g2 <- g2 + edge(2,4)
   g2 <- g2 + edge(3,4)
   g2 <- g2 + edge(5,6)
   g2 <- g2 + edge(5,7)
   g2 <- g2 + edge(6,7) # structural fold
   g3 <- g1 + edge(2,4)
   g3 <- g3 + edge(3,4)
   g3 <- g3 + edge(5,6)
   g3 <- g3 + edge(5,7) # intra-connected clusters
   g4 <- g3 + edge(2,7) # inter-connected clusters
   g5 <- make_ring(7) #circle graph
   g6 <- add_vertices(g5, 1)
   g6 <- g6 + edge(8,1) #circle graph wit pendant
   g7 <- make_full_graph(4, directed = FALSE)
   g7 <- add_vertices(g7, 1)
   g7 <- g7 + edge(1,5)
   plot(g7)
```

```{r Toy Networks Plots}
   png(here("Plots", "star.png"))
   plot.graph.norm(g1, l = "kk")
   dev.off()
   png(here("Plots", "sf.png"))
   plot.graph.norm(g2, l = "kk")
   dev.off()
   png(here("Plots", "intra.png"))
   plot.graph.norm(g3, l = "auto")
   dev.off()
   png(here("Plots", "inter.png"))
   plot.graph.norm(g4, l = "auto")
   dev.off()
   png(here("Plots", "circle.png"))
   plot.graph.norm(g5, l = "circle")
   dev.off()
   png(here("Plots", "circle-plus-one.png"))
   plot.graph.norm(g6, l = "circle")
   dev.off()
   png(here("Plots", "kite.png"))
   plot.graph.norm(g7, l = "kk")
   dev.off()
```

```{r Toy Network Distinction Tables}
    tab.cent(distinction(g1), name = "star", label = "tab:star")
    tab.cent(distinction(g2), name = "structfold", label = "tab:sf")
    tab.cent(distinction(g3), name = "intraclust", label = "tab:intra")
    tab.cent(distinction(g4), name = "interclust", label = "tab:inter")
    tab.cent(distinction(g5), name = "circle", label = "tab:circle")
    tab.cent(distinction(g6), name = "circleplus", label = "tab:circleplus")
    tab.cent(distinction(g6), name = "kite", label = "tab:kite")
```

## Medici

```{r Loading Medici Data}
   medici1 <- as.matrix(read.csv(here("Data", "MediciEdgeList.csv")))
   medici1 <- graph_from_edgelist(medici1, directed = FALSE)
   medici2 <- as.matrix(read.csv(here("Data", "MediciEdgeListMarriageCut.csv")))
   medici2 <- graph_from_edgelist(medici2, directed = FALSE)
   nomedici <- as.matrix(read.csv(here("Data", "NoMediciEdgeList.csv")))
   nomedici <- graph_from_edgelist(nomedici, directed = FALSE)
```

```{r Medici Distintion Plots}
   png(here("Plots", "medici.png"), height = 600, width = 1000)
      plot.graph.norm(medici1, ts = 5)
   dev.off()
   png(here("Plots", "nomedici.png"), height = 600, width = 1000)
      plot.graph.norm(nomedici, ts = 5)
   dev.off()
```

## Search

```{r Search Model Distinction}
   g <- as.matrix(read.csv(here("Data", "searchmodeltest.csv")))
   g <- graph_from_edgelist(g, directed = FALSE)
   distinction(g)
```

## Broker Computatinal Experiements

```{r}
   b <- make.broker.trees(30)
   c <- lapply(b, distinction.new, norm = FALSE)
```

```{r}
   library(patchwork)
   library(ggraph)
   gg <- function(x, lay.o = "kk", star = 1) {
      n <- vcount(x)
      V(x)$name <- 1:n
      c <- c(rep("tan2", n))
      c[star] <- "blue"
      gk <- which(degree(x) == 4)
      gk <- gk[gk != star]
      c[gk] <- "red"
      w <- ggraph(x, layout = lay.o) + 
      geom_edge_link(color = "steelblue") + theme_graph() +
      geom_node_point(size = 5, color = c) + 
      geom_node_text(aes(label = name), color = "white", size = 3) +
      ylim(-4, 3.5) + xlim(-4, 3.25) 
      return(w)
      }
   p.list <- lapply(b, gg)
   for (i in 1:length(p.list)) {
      p.list[[i]] <- p.list[[i]] + ggtitle(paste("N. Branches =", i+1)) +
         theme(plot.title = element_text(size = 11))
      }
   wrap_plots(p.list[c(1:6)], nrow = 2)
   ggsave(here("Plots", "tree-examples.png"), width = 12, height = 8, units = "in")
```

```{r}
   d.s <- sapply(c, function(x) {x[1, 3]})
   d.b <- sapply(c, function(x) {x[2, 3]})
   d.p <- sapply(c, function(x) {x[nrow(x), 3]})
   dat <- data.frame(d = c(d.s, d.b, d.p), 
         n = c(1:length(d.s)+1, 1:length(d.s)+1, 1:length(d.s)+1),
         g = c(rep(1, length(d.s)), rep(2, length(d.s)), 
         rep(3, length(d.s)))) |> 
         mutate(g = factor(g, labels = c("Star", "Gatekeeper", "Peripheral")))
   p <- ggplot(dat, aes(n, d, group = g, color = as.factor(g))) 
   p <- p + geom_point(size = 3)
   p <- p + geom_line(linewidth = 0.75)
   p <- p + geom_hline(yintercept = 0, color = "red", linetype = 2)
   p <- p + labs(y = "", x = "Number of Branches")
   p <- p + scale_x_continuous(breaks = seq(2, length(d.s), by = 2))
   p <- p + scale_color_manual(values = c("red", "blue", "tan2"))
   p <- p + theme_minimal()
   p <- p + theme(axis.text = element_text(size = 14, face = "bold"),
                  axis.title = element_text(size = 16, face = "bold"),
                  legend.text = element_text(size = 16, face = "bold"),
                  legend.title = element_blank(),
                  legend.position = "top"
                  )
   p
   ggsave(here("Plots", "broker-tree-roles-by-nbranches.png"), width = 7, height = 7, units = "in")
```


```{r}
   make.broker.cliques <- function(n = 10) {
      g1 <- make_full_graph(4, directed = FALSE)
      g2 <- make_full_graph(4, directed = FALSE)
      g3 <- g1 + g2
      g3 <- add_vertices(g3, 1)
      g3 <- g3 + edge(9,4)
      g3 <- g3 + edge(9,5)
      el <- vector(mode = "list", length = n)
      el[[1]] <- g3
      a <- 10
      for (i in 2:n) {
         g3 <- g3 + make_full_graph(4, directed = FALSE)
         g3 <- g3 + edge(9,a)
         el[[i]] <- g3
         a <- a + 4
         }
   return(el)
   }
   b <- make.broker.cliques(30)
   b.r <- lapply(b, function(x) {rewire(x, each_edge(p = .05, loops = FALSE, multiple = FALSE))})
   c <- lapply(b, distinction.new, norm = FALSE)
```

```{r}
   p.list <- lapply(b, gg, star = 9)
   for (i in 1:length(p.list)) {
      p.list[[i]] <- p.list[[i]] + ggtitle(paste("N. Branches =", i+1)) +
         theme(plot.title = element_text(size = 11))
      }
   wrap_plots(p.list[c(1:6)], nrow = 2)
   ggsave(here("Plots", "clique-examples.png"), width = 12, height = 8, units = "in")
```

```{r}
   d.s <- sapply(c, function(x) {x[9, 3]})
   d.b <- sapply(c, function(x) {x[4, 3]})
   d.p <- sapply(c, function(x) {x[1, 3]})
   dat <- data.frame(d = c(d.s, d.b, d.p), 
         n = c(1:length(d.s)+1, 1:length(d.s)+1, 1:length(d.s)+1),
         g = c(rep(1, length(d.s)), rep(2, length(d.s)), 
         rep(3, length(d.s)))) |> 
         mutate(g = factor(g, labels = c("Star", "Gatekeeper", "Peripheral")))
   p <- ggplot(dat, aes(n, d, group = g, color = as.factor(g))) 
   p <- p + geom_point(size = 3)
   p <- p + geom_line(linewidth = 0.75)
   p <- p + geom_hline(yintercept = 0, color = "red", linetype = 2)
   p <- p + labs(y = "", x = "Number of Branches")
   p <- p + scale_x_continuous(breaks = seq(2, length(d.s), by = 2))
   p <- p + scale_color_manual(values = c("red", "blue", "tan2"))
   p <- p + theme_minimal()
   p <- p + theme(axis.text = element_text(size = 14, face = "bold"),
                  axis.title = element_text(size = 16, face = "bold"),
                  legend.text = element_text(size = 16, face = "bold"),
                  legend.title = element_blank(),
                  legend.position = "top"
                  )
   p
   ggsave(here("Plots", "broker-cliques-roles-by-nbranches.png"), width = 7, height = 7, units = "in")
```


```{r}

```